# VR-ML модуль
## Описание
Модуль виртуальной расходометрии содержит 4 микросервиса:

* микросервис расчета показателя целевых признаков "Расход по газу Вентури, ksm3/h" ("Расход по воде Вентури, sm3/h", "Расход по конденсату Вентури, sm3/h") по каждой скважине (predict);

* микросервис получения истории запросов и результатов расчета целевых признаков по каждой скважине  (history);

* микросервис проверки доступности модели по конкретной скважине (availability_of_model);

* микросервис проверки доступности VR-ML модуля (healthcheck).

## Запуск

### Запуск отдельного микросервиса в контейнере
Для запуска отдельного микросервиса необходимо задействовать docker-compose.yaml и 
Dockerfile из корневой директории сервиса (указав в docker-compose.yaml 
необходимый порт для прослушивания сервиса, по умолчанию 8080), выполнив команду:
```shell
docker-compose up
```
или для запуска в фоновом режиме команду:
```shell
docker-compose up -d
```
Проверить статус запуска докер контейнеров можно с помощью команды
```shell
docker ps -a
```

### Локальный запуск микросервиса
Для локального запуска микросервиса необходимо:
* клонировать репозиторий:
```shell
git clone https://github.com/OGPT-tech/VR_ML.git
```
* создать виртуальное окружение, выполнив в корневой директории команду:
```shell
python -m venv venv
```
* активировать виртуальное окружение

    * Linux
    ```shell
    source venv/bin/activate
    ```
    * Windows
    ```shell
    .\venv\Scripts\activate
    ```
* установить зависимости:
```shell
python -m pip install -r requirements.txt
```
* выполнить команду:
```shell
python server_fastapi.py
```

## Описание API

### Микросервис расчета целевых показателя Вентури

#### Расчет коэффициентов "Расход по газу Вентури"

Метод рассчитывает коэффициенты расхода по газу Вентури на основе предоставленного запроса.

```proto
Роут http://[server_ip]:[service_port]/predict
Отправляются методом post параметры для идентификации модели и расчета целевого показателя по определенной скважине.
Пример запроса:
url = "http://127.0.0.1:8080/predict"
header = {'Content-Type': 'application/json', 'Accept': 'application/json'}
data = {
 "features" : {
       "Давление": 90.88675,
       "Давление забойное": 121.2221,
       "Давление над буферной задвижкой ФА": 105.3206,
       "Процент открытия штуцера":1,
       "Температура на выкидной линии": 52.93959,
       "Температура": 58.16667,
       "Температура забойная": 70.44377
 },
 "well_id":524,
 "target_name":"Расход по газу"
}
resp = requests.post(url, data=json.dumps(data), headers=header)
 
```
Входные параметры:
- `well_id`: идентификатор скважины (целочисленное значение). На текущий момент доступны активные модели по скважинам с 2-х технологических линий с well_id: 521, 517, 528, 510, 511, 516, 529, 505, 502, 503, 504, 522, 525, 513, 524, 552, 501, 506, 508, 554, 507;
  
- `target_name`: целевая переменная для расчета "Расход по газу";

- `features`: список входных переменных модели для предсказания;

   - `Давление`, barg;

   - `Давление забойное`, barg;

   - `Давление над буферной задвижкой ФА`, barg;

   - `Процент открытия штуцера`, %;

   - `Температура на выкидной линии`, degC;

   - `Температура`, degC;

   - `Температура забойная`, degC;


#### Результаты:
- `Расход по газу`: значения показателя расхода по газу Вентури, ksm3/h;
```proto
Пример ответа:
{
 "Расход по газу": 57.579872131347656
}
```


### Микросервис получения истории успешных запросов

#### Получение исторических данных за временной интервал по успешным запросам на расчет целевых признаков

Метод возвращает данные по результатам работы модели по полученным в запросе входным параметрам и успешным
ответам (по которым были получены рассчитанные  показатели).


```proto
Роут http://[server_ip]:[service_port]/history
Отправляются методом post параметры для идентификации модели, временного интервала и целевого показателя.
Пример запроса:
url = "http://127.0.0.1:8080/history"
header = {'Content-Type': 'application/json', 'Accept': 'application/json'}
data = {
 "well_id": 529,
 "target_name": "Расход по газу",
 "start_date": "24-11-2023 16:34:27”,
 "end_date": "24-11-2023 16:34:27
}
resp = requests.post(url, data=json.dumps(data), headers=header)
```
Параметры:

- `well_id`: идентификатор скважины (целочисленное значение);

- `target_name`: целевая переменная для расчета "Расход по газу";

- `start_date`: начало временного интервала наблюдения;
  
- `end_date`: конец временного интервала наблюдения;

*start_date и end_date опционные  поля. Eсли не будут переданы, возьмется максимально возможный интервал в исторических данных.

#### Результаты:
- `features`: входные переменные модели;
- `target_name`: название целевой переменной Вентури (Расход по газу, Расход по воде, Расход по конденсату), по которой происходил расчет;
- `well_id`: идентификатор скважины, по которой происходил расчет целевой переменной Вентури;
- `timestamp`: дата и время запроса;
- `speed_time`: время обработки запроса, сек.;
```proto
Пример ответа:
{
 "features":
 "{
    'delta_p1': 15.901499999999999,
    'delta_p4': 14.433849999999993,
    'delta_p5': 30.33534999999999,
    'delta_t1': 17.504179999999998,
    'Давление': 90.88675,
    'Давление забойное': 121.2221,
    'Давление над буферной задвижкой ФА': 105.3206,
    'Процент открытия штуцера': 1,
    'Температура на выкидной линии': 52.93959,
    'Температура': 58.16667,
    'Температура забойная': 70.44377,
    'pzab_sq': 14694.79752841,
    'stuts_sq_delta_p4_sqrt': 3.7991907032945837
 }",
 "score": 31.40961456298828,
 "target_name": "Расход по газу",
 "well_id": 502,
 "timestamp": "24-11-2023 17:45:55"б
 "speed_time":0.74
}

```


### Микросервис проверки доступности модели

#### Получение информации о наличии активной модели по идентификатору скважины и наименованию целевого признака.

Метод позволяет проверить, существует ли активная (действующая) модель для расчета показателя "Расход по газу Вентури" по определенной скважине.


```proto
Роут http://[server_ip]:[service_port]/availability_of_model
Отправляются методом post параметры для проверки наличия активной модели.
Пример запроса:
url = "http://127.0.0.1:8080/availability_of_model"
header = {'Content-Type': 'application/json', 'Accept': 'application/json'}
data = {
 "well_id": 529
}
resp = requests.post(url, data=json.dumps(data), headers=header)
```
Параметры:

- `well_id`: идентификатор скважины;

#### Результаты:
- `model_id`: идентификатор модели, обслуживающей скважину, по которой происходит запрос;
- `model_status`: статус модели: true - активная действующая модель, false - модель отсутствует;
```proto
Пример ответа:
{
    "model_id": 529,
    "model_status": true
}
```

### Микросервис проверки доступности сервиса

#### Получение информации об активности сервиса

Метод позволяет получить информацию с сервера о работоспособности сервиса (чтобы убедиться что сервис готов к приему запросов на расчет целевых показателей).

```proto
Роут http://[server_ip]:[service_port]/healthcheck
Отправляются методом get  без дополнительных параметров для проверки доступности сервиса.
Пример запроса:
url    = "http://127.0.0.1:8080/healthcheck"
header = {'Content-Type': 'application/json', 'Accept': 'application/json'}
resp   = requests.get(url, headers=header)
```
Параметры:
отсутствуют

#### Результаты:

   - `checker`: статус проверки сервиса;
   
   - `output`: сообщение о проверки;
     
   - `passed`: статус запроса (пройден/не пройден);
 
   - `timestamp`: время пришедшего запроса в формате timestamp;
    
   - `expires`: время завершения проверки в формате timestamp;
 
   - `response_time`: скорость ответа в секундах;
     
```proto
Пример ответа:
{
    "checker": "available",
    "output": "All work",
    "passed": true,
    "timestamp": 1701184999.5545988,
    "expires": 1701185026.5545988,
    "response_time": 0.0
}
```
