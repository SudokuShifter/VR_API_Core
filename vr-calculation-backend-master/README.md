# VR-Calculation-Backend

## Назначение микросервиса
Микросервис представляет собой интерфейс, который обеспечивает взаимодействие платформы ZIIOT
с микросервисами "Виртуальный расходомер" (далее расчетный модуль), а так же обеспечивает настройку 
расчетного модуля через пользовательский интерфейс системы.

Микросервис обеспечивает:
- [ ]  Выгрузку архивных данных из платформы ZIIOT
- [ ]  Перевод данных в единицы измерения расчетного модуля и обратно
- [ ]  Агрегацию данных для передачи в расчетный модуль
- [ ]  Запись результатов расчета в теги платформы ZIIOT
- [ ]  Управление расчетным модулем
- [ ]  Хранение пользовательских настроек и промежуточных расчетных данных
- [ ]  Авторизированный доступ к функциям системы через Keycloak платформы ZIIOT 

## Запуск микросервиса
Запуск микросервиса выполняется при помощи docker-compose.yaml из корневой директории сервиса. Перед запуском
необходимо выполнить развертывание платформы ZIIOT с объектной моделью, развертывание базы данных Postgresql 
с последующим созданием таблиц при помощи SQL скриптов (расположены в папке sql_scripts в корневой директории) 
и настройку переменных окружения.

Описание переменных окружения:
- `SERVER_PORT` - Порт микросервиса, Default value = 8080 (необязательный параметр)
- `AUTH_API_CLIENT_ID` - CLIENT_ID для авторизации в API сервиса
- `AUTH_API_CLIENT_SECRET` - SECRET для авторизации в API сервиса
- `AUTH_API_GRAND_TYPE` - тип авторизации, Default value = authorization_code
- `AUTH_ISSUER_URI` - URI для получения настроек от Keycloak
- `AUTH_RESOURCE_SERVER` - URI RESOURCE SERVER платформы Keycloak
- `AUTH_SERV_CLIENT_ID` - CLIENT_ID для авторизации в API платформы ZIIOT
- `AUTH_SERV_CLIENT_SECRET` - SECRET для авторизации в API платформы ZIIOT
- `AUTH_SERV_GRAND_TYPE` - тип авторизации, Default value = client_credentials
- `DB_HOST` - HOST базы данных Postgresql
- `DB_NAME` - Имя базы данных Postgresql
- `DB_USER` - Имя пользователя для доступа к базе данных Postgresql
- `DB_PASSWORD` - Пароль для доступа к базе данных Postgresql
- `DB_PORT` - Порт базы данных Postgresql
- `DB_SCHEME` - Имя схемы базы данных Postgresql
- `FMM_HOST` - HOST FMM микросервиса расчетного модуля
- `FMM_SCHEME` - Протокол FMM микросервиса расчетного модуля
- `FMM_PORT` - Порт FMM микросервиса расчетного модуля (необязательный параметр)
- `ML_HOST` - HOST ML микросервиса расчетного модуля
- `ML_SCHEME` - Протокол ML микросервиса расчетного модуля
- `ML_PORT` - Порт ML микросервиса расчетного модуля (необязательный параметр)
- `ZIF_HOST` - HOST платформы ZIIOT
- `ZIF_SCHEME` - Протокол доступа к платформе ZIIOT
- `VR_TASK_CRON` - CRON выражение для запуска FMM и ML задач
- `VR_CANONICAL_FACTOR_CRON` - CRON для обновления коэффициентов пересчета в систему СИ
- `VR_TASK_DATE_START` - Начальное дата запуска FMM и ML задач по умолчанию. Устанавливается в случае отсутствия
текущей даты в БД для scheduler DATA_FOUND type.
- `VR_TASK_VALIDATION_COUNT_DAYS` - Количество дней, за которые выполняется задача валидации

Запуск микросервиса выполняется при помощи команды:
```shell
docker-compose up
```
Или для запуска в фоновом режиме при помощи команды:
```shell
docker-compose up -d
```
Проверить статус запуска докер контейнеров можно с помощью команды
```shell
docker ps -a
```

## Архитектурные решения

Архитектура взаимодействия сервисов представлена на диаграмме ниже.

![architecture.png](diagram%2Farchitecture.png)

VR Calculation backend (далее backend) обеспечивает выгрузку архивных данных из платформы ZIIOT по каждой скважине. 
После выгрузки данных производится их консолидация и подготовка для отправки в микросервисы расчетного модуля. 
Результаты выполнения задач расчетного модуля backend укладывает в соответствующие теги платформы ZIIOT.
Перечень скважин хранится в базе данных PostgreSQL, таблица vr_zif_objects.

Расчет FMM и ML задач выполняется по расписанию. Настройка планировщика выполняется через переменную vr-type-scheduler.
Значение по умолчанию DATA_FOUND. Доступны варианты настройки планировщика:
- с фиксированным временным шагом (значение FIXED_TIME)
- по наличию данных (значение DATA_FOUND)
- планировщик отключен (значение SCHEDULER_OFF)

### Планировщик с фиксированным шагом
Планировщик выполняет запуск задач FMM и ML для всех скважин за текущую метку времени. В начале старта метка времени
равна переменной окружения `VR_TASK_DATE_START`. Далее в каждом цикле планировщика выполняется увеличение метки
времени на шаг платформы ZIIOT. Настройка планировщика выполняется при помощи CRON выражения в переменной окружения 
`VR_TASK_CRON` (т.е. в переменной `VR_TASK_CRON` задается частота выполнения FMM и ML задач). В первой итерации
планировщика происходит запрос данных валидации в последовательном режиме для всех скважин.

### Планировщик по наличию данных
Планировщик обеспечивает управление процессами выполнения задач. Частота опроса процессов задается при помощи 
CRON выражения в переменной окружения `VR_TASK_CRON`. Если процесс выключен, то планировщик выполнит его запуск. Если
поле scheduler_status установлено в значение OFF, то планировщик не выполняет управление процессов (т.е. процесс
отключен). В начале первого запуска приложения выполняется прохождение задач валидации для все скважин в состоянии ON
в параметре scheduler_status в таблице vr_zif_objects.

Старт нового процесса начинается с получения стартовой даты. Стартовые даты формируются путем опроса поля 
current_date_scheduler из таблицы vr_zif_objects. В случае если дата не установлена (пришло значение null или empty) 
в стартовую дату подставляется значение из переменной окружения `VR_TASK_DATE_START`. После формирования стартовых дат 
происходит проверка наличия данных в тегах за дату глубины валидации данных (текущая дата выполнения задач + TIME_STEP *
vr-task-scheduler-deep-validation) с дельтой, равной TIME_STEP * vr-task-scheduler-check-step-after.
Далее выполняется запуск задачи валидации FMM и после запускаются задачи расчета ML и FMM
от текущей даты до даты валидации данных. Процесс выполняется до тех пор, пока данные не пройдут валидацию или 
процесс будет переведен в статус OFF. Для каждой скважины запускается отдельный асинхронный процесс.

### Задачи валидации и адаптации

Помимо архивных данных по скважинам для решения FMM задачи требуются данные задач адаптации и валидации. Результаты
выполнения задач валидации и адаптации хранятся в базе данных PostgreSQL в таблицах vr_validation_data и 
vr_adaptation_data соответственно. Каждый запрос на решение FMM задачи обеспечивает выгрузку активных данных по
задачам адаптации и валидации из базы данных PostgreSQL.

#### Задача валидации
Задача валидации выполняется перед каждой FMM задачей за промежуток времени, равный количеству
дней в переменной окружения `VR_TASK_VALIDATION_COUNT_DAYS` со смещением назад относительно метки времени FMM задачи.
Ввиду того, что задача валидации требует выгрузки больших объемов данных из платформы, backend выполняет 
кеширование выгруженных данных в оперативной памяти. Таким образом из платформы будут запрошены только 
недостающие данные, что существенно снижает нагрузку на сервис UDL платформы ZIIOT. Каждый запрос выполнения задачи
валидации обновляет данные результатов в таблице vr_validation_data. С frontend системы можно указать пользовательские 
значения задачи валидации. В этом случае любой запуск задачи валидации не будет обновлять данные в таблице
vr_validation_data. За управление задачей валидации отвечают следующие endpoint-ы: `GET /api/v1/validate` - выполнение
задачи валидации, `GET /api/v1/validate/get` - получение результата валидации из базы данных, 
`PUT /api/v1/validate/set` - установка пользовательских значений или их отмена. 

#### Задача адаптации
Задача адаптации выполняется по запросу через frontend системы. Данные адаптации сохраняются в базу данных Postgres
в таблицу vr_adaptation_data. С frontend можно получить все ранее произведенные адаптации для скважины и выбрать
значения адаптации, которые будут использоваться в последующих расчетах.
За управление и получение адаптационных данных отвечают следующие endpoint-ы: `GET /api/v1/adaptation` - выполнение
задачи адаптации, `GET /api/v1/adaptation/all` - получение все результаты адаптации из базы данных,
`GET /api/v1/adaptation/active` - получить активные данные адаптации, `PUT /api/v1/adaptation/set` - 
установить выбранные данные адаптации для последующих расчетов.

### FMM задача
Запуск FMM задачи выполняется по расписанию, по ранее описанному алгоритму. Помимо расписания, FMM задачу возможно 
запустить при помощи API сервиса. Доступно 3 варианта запуска: 
* за точку времени `GET /api/v1/fmm`
* за временной интервал в последовательном режиме `GET /api/v1/fmm/duration`
* за временной интервал в параллельном режиме `GET /api/v1/fmm/duration/parallel`

В случае последовательного запуска все задачи выполняются последовательно. Для каждой задачи запрашиваются данные
валидации. В случае параллельного запуска весь список задач разбивается на группы с количеством задач, равным
количеству ядер процессора. Для каждой группы рассчитывается задача валидации. После расчета задачи валидации для 
группы выполняется FMM задача для каждой точки времени из этой группы. Группы задач выполняются в последовательном
режиме, т.е. пока не завершатся все задачи первой группы, задачи из новой группы выполняться не будут.

### ML задача
Запуск ML задачи выполняется по расписанию, по ранее описанному алгоритму. Часть данных для ML задачи берется из
запроса на выполнение FMM задачи, таким образом исключаются лишние запросы. Помимо расписания, ML задачу возможно
запустить при помощи API сервиса. Доступно 2 варианта запуска:
* за точку времени `GET /api/v1/ml`
* за временной интервал в последовательном режиме `GET /api/v1/ml/duration`

___Архитектурными решениями не предусматривается одновременная работа задач по расписанию и через API. В случае
необходимости одновременного запуска должны быть развернуты отдельные инстансы backend.___

### Коэффициенты пересчета данных
Backend обеспечивает перевод значений, хранящихся в платформе ZIIOT в единицы измерения расчетного модуля.
Единицы измерений и переводные коэффициенты задаются в объектной модели платформы. Backend запрашивает переводные
коэффициенты из объектной модели по требованию и кеширует их. Далее данные возвращаются из кеша. Планировщик
выполняет обновление коэффициентов. Частота обновления задается при помощи CRON выражения в переменной 
окружения `VR_CANONICAL_FACTOR_CRON`.

## Схема базы данных

Схема базы данных представлена на диаграмме ниже.

![VR-Diagram.png](diagram%2FVR-Diagram.png)

В таблице vr_zif_objects хранятся UID идентификаторы скважин из объектной модели платформы. В таблице 
vr_zif_additional_objects хранятся дополнительные UID идентификаторы объектов модели, таких как манифольд или 
сепаратор. Связь выше перечисленных таблиц выполняется по схеме many to many через промежуточную таблицу
vr_zif_object_2_additional_object. 

В таблицах vr_adaptation_data и vr_validation_data хранятся данные адаптации и валидации соответственно для каждой
из скважин. Данные таблицы связаны с таблицей vr_zif_objects связью many to one.

## Описание Endpoint-ов системы

Описание Endpoint-ов системы доступно в Swagger после развертывания модуля по ссылке 
[/webjars/swagger-ui/index.html](http://localhost:8080/webjars/swagger-ui/index.html).
